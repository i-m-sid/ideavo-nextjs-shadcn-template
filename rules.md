# Project Rules and Guidelines

## Next.js 14 App Router Best Practices

### App Directory Structure

- Use the `app/` directory for App Router (not `pages/`)
- File-based routing with folders and special files (`page.tsx`, `layout.tsx`, `loading.tsx`, `error.tsx`)
- API routes are now Route Handlers in `app/api/*/route.ts`

### Server vs Client Components

#### Server Components (Default)

- Use by default for better performance and security
- Direct database access and API calls without exposing credentials
- Automatic request memoization with `fetch()`
- No need for `"use client"` directive

#### Client Components ("use client")

- Add `"use client"` directive ONLY when needed:
  - Interactive components (onClick, onChange, useEffect, useState, etc.)
  - Browser-only APIs (localStorage, document, window, navigator)
  - React hooks (useState, useEffect, useContext, etc.)
  - Event handlers and user interactions
- **CRITICAL**: Place directive at the very top of the file (first line)
- Use sparingly - prefer Server Components by default
- Once a component uses `"use client"`, all its children are also client components

#### Server Actions ("use server")

- Add `"use server"` for form actions and server-side mutations
- **CRITICAL**: Must be at the very top of the function or file
- Use for database mutations called from client components
- Enables progressive enhancement with forms
- Can be defined inline in Server Components or in separate files

#### Directive Placement Rules

- **ALWAYS** place directives as the first line of the file
- **NEVER** add directives at the end or middle of files
- **NEVER** add `"use client"` unless component needs browser APIs or interactivity

### API Route Handlers (App Router)

- File naming: `app/api/*/route.ts` (not `pages/api/*`)
- HTTP methods: Export named functions (`GET`, `POST`, `PUT`, `DELETE`, etc.)
- Use Web APIs (`Request`, `Response`) instead of Node.js APIs

### Performance Optimization

- Use parallel data fetching to avoid waterfalls
- Implement streaming with `<Suspense>` and `loading.tsx`
- Leverage automatic request memoization
- Prefer Server Components for initial data loading

### Error Handling

- Avoid hydration mismatches: `"Warning: Extra attributes from the server"`
- Use `error.tsx` for route-level error boundaries
- Handle async errors in Server Components properly

## Technology Stack

### Core Dependencies
This template includes:
- **Next.js 14** - React framework with App Router
- **React 18** - UI library
- **TypeScript** - Type safety
- **Tailwind CSS** - Utility-first CSS framework
- **shadcn/ui** - Pre-built component library
- **Lucide React** - Icon library
- **Prisma ORM** - Database toolkit

### Database Guidelines
- Use **Prisma** for all database operations
- Define models in `prisma/schema.prisma`
- Use TypeScript types generated by Prisma Client
- Follow Prisma naming conventions (PascalCase for models, camelCase for fields)
- Use appropriate field types and constraints
- Always include `id`, `createdAt`, and `updatedAt` fields for tracking

#### Database Migration Best Practices (CRITICAL)
- **CRITICAL**: ALWAYS use `npx prisma migrate dev --name migration_name` for creating migrations with specific names
- Always use the following format for migration name: `YYYYMMDD_HHMMSS_description`

#### TypeScript Type Handling with Prisma
- **CRITICAL**: Prisma returns `null` for nullable fields, but TypeScript interfaces often use `undefined`
- Always handle null/undefined conversion when mapping Prisma results to interface types
- Use `field || undefined` pattern to convert null to undefined when needed
- Create helper functions to handle type conversion consistently
- Example pattern:
  ```typescript
  return {
    id: user.id,
    email: user.email,
    displayName: user.displayName || undefined,
    avatar: user.avatar || undefined,
  }
  ```

## UI and Styling Guidelines

### Icons and Images
- Use **Lucide React** for all icons and logos
- Do NOT install additional icon packages unless absolutely necessary
- Use Unsplash stock photos with known valid URLs only

### Component Library
- Use **shadcn/ui** components as the primary UI library
- Do NOT install other UI theme packages unless explicitly requested
- Customize components through Tailwind CSS classes

## File Management Rules

### Protected Files - NEVER MODIFY
```
components/ui/*          # shadcn/ui components
hooks/use-toast.ts       # Toast hook implementation
.gitignore              # Git ignore configuration
.ideavo/*               # IDE configuration
```

### Environment Variables
- Use `.env` file for ALL environment variables
- NEVER create `.env.local`, `.env.example`, or other env files
- Environment variable checking page available at `/env-check`
- **CRITICAL**: When adding new environment variables, update `lib/env-config.ts`. Follow the ENV_VARIABLES array structure: name, description, instructions

## Code Quality Standards

### Error Handling
- Always handle database errors appropriately
- Use try-catch blocks for async operations
- Provide meaningful error messages

### Performance
- Use Server Components when possible
- Implement proper data fetching patterns
- Optimize database queries with Prisma

### Dependency Management
- Always verify dependencies exist in `package.json` before importing modules
- Install TypeScript type definitions immediately: `npm i --save-dev @types/package-name`
- Check for missing type declarations and install them proactively

### Development Workflow
- Test builds after significant changes
- Keep running build until build succeeds without any errors